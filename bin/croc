#!/usr/bin/env ruby
require "rubygems"
require "croc"

$rdoc_root = "/Library/Ruby/Gems/1.8/doc"
$gems = []
$classes = {}
$methods = []
$gem_home = find_gem_home

install_assets

get_specs.each do |spec|
  if spec.has_rdoc?
    gem_dir = File.join($gem_home, "#{spec.name}-#{spec.version}")
    unless File.exists?(gem_dir)
      puts "Installing #{spec.name}-#{spec.version} in your Library gem directory"
      `gem install -v #{spec.version} #{spec.name}`
    end

    rdoc_dir = File.join($rdoc_root, "#{spec.name}-#{spec.version}", "rdoc")
    unless File.exists?(rdoc_dir)
      puts "Installing #{spec.name}-#{spec.version} rdocs"
      `gem rdoc -v #{spec.version} #{spec.name}`
    end

    index_gem(spec)
  end
end

File.open(File.join(user_home_dir, ".croc", "data.js"), "w") do |f|
  f.puts       "gems = ["
  $gems.each do |gem|
    f.puts     "  {name: '#{gem[:name]}', dir: '#{gem[:dir]}', classes: ["
    gem[:classes].each_pair do |key, value|
      f.puts   "    {name: '#{key}', url: '#{value[:url]}', methods: ["
      value[:methods].each do |method|
        f.puts "      {name: '#{method[:name]}', url: '#{method[:url]}'},"
      end
      f.puts   "    ]},"
    end
    f.puts     "  ]},"
  end
  f.puts       "];"
end

puts "Bookmark file://#{File.join(user_home_dir, ".croc", "index.html")}"
