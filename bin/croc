#!/usr/bin/env ruby
require "rubygems"
require "croc"

$rdoc_root = "/Library/Ruby/Gems/1.8/doc"
$gems = []
$classes = {}
$methods = []
$gem_home = find_gem_home

install_assets

get_specs.each do |spec|
  if spec.has_rdoc?
    gem_dir = File.join($gem_home, "#{spec.name}-#{spec.version}")
    unless File.exists?(gem_dir)
      puts "Installing #{spec.name}-#{spec.version} in your Library gem directory"
      `gem install -v #{spec.version} #{spec.name}`
    end

    rdoc_dir = File.join($rdoc_root, "#{spec.name}-#{spec.version}", "rdoc")
    unless File.exists?(rdoc_dir)
      puts "Installing #{spec.name}-#{spec.version} rdocs"
      `gem rdoc -v #{spec.version} #{spec.name}`
    end

    index_gem(spec)
  end
end

idx = -1
#File.open(File.join(user_home_dir, ".croc", "data.js"), "w") do |f|
File.open(File.join("public/data.js"), "w") do |f|
  f.puts       "objs = ["
  $gems.each do |gem|
    f.puts     "  {t: 'g', p: null, n: '#{gem[:name]}', l: '#{gem[:name].downcase}', u: '#{gem[:dir]}'},"
    idx += 1
    gidx = idx
    gem[:classes].each_pair do |key, value|
      f.puts   "  {t: 'c', p: #{gidx}, n: '#{key}', l: '#{key.downcase}', u: '#{value[:url]}'},"
      idx += 1
      cidx = idx
      value[:methods].each do |method|
        f.puts "  {t: 'm', p: #{cidx}, n: '#{method[:name]}', l: '#{method[:name].downcase}', u: '#{method[:url]}'},"
        idx += 1
      end
    end
  end
  f.puts       "];"
end

puts "Bookmark file://#{File.join(user_home_dir, ".croc", "index.html")}"
